<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¤ë®¤ë‹ˆí‹° ê¸€ ë³´ê¸°</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body data-page="community-post">
    <div class="page">
        <!-- Header -->
        <div class="header-wrapper">
            <div class="header-top">
                <a href="index.html" class="brand brand-animate" style="text-decoration:none;">
                    <span>Job</span><span>Road</span><span>Map</span>
                </a>
                <div class="header-actions">
                    <a href="#">ê¸°ì—…ì„œë¹„ìŠ¤</a>
                </div>
            </div>
            <div class="header-nav">
                <div class="nav-container">
                    <a href="builder.html">ë¡œë“œë§µ ë§Œë“¤ê¸°</a>
                    <a href="my-roadmaps.html">ë‚´ ë¡œë“œë§µ</a>
                    <a href="profile.html">ë‚´ ì •ë³´</a>
                    <a href="hiring.html">ì±„ìš©ê³µê³ </a>
                    <a href="community.html">ì •ë³´ê³µìœ </a>
                </div>
            </div>
        </div>

        <main class="main-container">
            <section class="panel">
                <div id="postContent">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </section>
            <section class="panel">
                <div class="panel__header">
                    <div>
                        <p class="eyebrow">ëŒ“ê¸€</p>
                        <h2>ì˜ê²¬ ë‚¨ê¸°ê¸°</h2>
                    </div>
                </div>
                <div id="comments" class="cards empty">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                <div class="card">
                    <textarea id="commentInput" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    <button id="commentSubmit">ë“±ë¡</button>
                    <p id="commentStatus" class="status"></p>
                </div>
            </section>
        </main>

        <footer>
            <p>JobRoadMap â€” ì»¤ë¦¬ì–´ ì„±ì¥ì˜ íŒŒíŠ¸ë„ˆ</p>
        </footer>
    </div>
    <script src="api-config.js"></script>
    <script>
        const API_BASE = (window.API_BASE && window.API_BASE.trim()) || 'http://localhost:8080';
        const params = new URLSearchParams(window.location.search);
        const postId = params.get('id');
        attachNav();
        loadPost();

        async function loadPost() {
            const box = document.getElementById('postContent');
            try {
                const res = await fetch(`${API_BASE}/api/community/posts/${postId}`);
                if (!res.ok) throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                const p = await res.json();
                box.innerHTML = `
            <div class="view-content">
                <div class="view-header">
                    <div class="view-subject">
                        <span class="view-category">[${p.category || 'ì¼ë°˜'}]</span>
                        <h1 class="view-title">${p.title}</h1>
                    </div>
                    <div class="view-info">
                        <span class="view-author">${p.author || p.authorEmail || 'ìµëª…'}</span>
                        <span class="view-sep">|</span>
                        <span class="view-date">${(p.createdAt || '').toString().split('T')[0] || ''}</span>
                    </div>
                </div>
                <div class="view-body">
                    ${(p.content || '').replace(/\n/g, '<br>')}
                    ${p.attachmentName ? `<div class="view-attachment"><a href="${p.attachmentData}" download="${p.attachmentName}">ğŸ’¾ ${p.attachmentName}</a></div>` : ''}
                </div>
            </div>
        `;
                renderComments(p.comments || []);
            } catch (e) {
                box.textContent = e.message;
            }
        }

        function renderComments(list) {
            const wrap = document.getElementById('comments');
            if (!list.length) {
                wrap.innerHTML = '<p class="empty">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            wrap.classList.remove('empty');
            wrap.innerHTML = `
        <div class="comment-list">
            ${list.map(c => `
                <div class="comment-item">
                    <div class="comment-meta">
                        <span class="comment-author">${c.author || c.authorEmail || 'ìµëª…'}</span>
                        <span class="comment-date">${(c.createdAt || '').toString().split('T')[0] || ''}</span>
                    </div>
                    <div class="comment-text">${c.content}</div>
                </div>
            `).join('')}
        </div>
    `;
        }

        document.getElementById('commentSubmit').addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            const content = document.getElementById('commentInput').value.trim();
            if (!content) return;
            const status = document.getElementById('commentStatus');
            try {
                const res = await fetch(`${API_BASE}/api/community/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Auth-Token': token },
                    body: JSON.stringify({ content })
                });
                if (!res.ok) throw new Error('ë“±ë¡ ì‹¤íŒ¨');
                document.getElementById('commentInput').value = '';
                loadPost();
                status.textContent = '';
            } catch (e) {
                status.textContent = e.message;
            }
        });

        function attachNav() {
            const loginBtn = document.getElementById('navLogin');
            const signupBtn = document.getElementById('navSignup');
            const logoutBtn = document.getElementById('navLogout');
            if (loginBtn) loginBtn.onclick = () => window.location.href = 'login.html';
            if (signupBtn) signupBtn.onclick = () => window.location.href = 'signup.html';
            if (logoutBtn) logoutBtn.onclick = () => {
                const token = localStorage.getItem('token');
                if (token) fetch(`${API_BASE}/api/auth/logout`, { method: 'POST', headers: { 'X-Auth-Token': token } }).finally(() => localStorage.removeItem('token'));
            };
        }
    </script>
</body>

</html>
